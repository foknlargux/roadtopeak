<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Calendario de Ejercicios de Escalada</title>
  <style>
    body {
      margin: 0;
      padding: 40px;
      background: linear-gradient(to right, #ece9e6, #ffffff);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    .calendar-wrapper {
      background-color: #ffffff;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.1);
      padding: 30px;
      max-width: 900px;
      width: 100%;
      animation: fadeIn 1s ease-in-out;
      position: relative;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .youtube-button {
      position: absolute;
      top: 20px;
      right: 20px;
      background-color: #ff0000;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 1.4em;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      transition: transform 0.2s ease, background-color 0.2s ease;
    }

    .youtube-button:hover {
      transform: scale(1.1);
      background-color: #e60000;
    }

    h1 {
      text-align: center;
      font-size: 2.2em;
      margin-bottom: 10px;
      color: #2c3e50;
    }

    h1::before {
      content: "üßó‚Äç‚ôÇÔ∏è ";
    }

    .subtitle {
      text-align: center;
      font-size: 1em;
      color: #7f8c8d;
      margin-bottom: 20px;
    }

    .top-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
    }

    .top-button {
        padding: 10px 20px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1em;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.2s ease;
    }

    .top-button:hover {
        background-color: #2980b9;
        transform: translateY(-2px);
    }

    .calendar {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 12px;
    }

    .day {
        position: relative;
        padding: 20px 10px;
        text-align: center;
        border-radius: 10px;
        font-weight: bold;
        font-size: 1.3em;
        color: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        transition: transform 0.2s ease;
        cursor: pointer;
    }

    .day:hover {
        transform: translateY(-4px);
    }

    .day.inactive {
        background-color: #95a5a6 !important;
        cursor: not-allowed;
    }

    .day.completed {
        background-color: #95a5a6 !important;
        cursor: default;
    }

    .lock-button {
        position: absolute;
        top: 6px;
        left: 6px;
        background: rgba(0,0,0,0.3);
        border: none;
        border-radius: 4px;
        color: white;
        font-size: 0.9em;
        cursor: pointer;
        padding: 2px 6px;
        display: none;
    }

    .day.completed .lock-button {
        display: block;
    }

    .red {
        background-color: #e74c3c;
    }

    .green {
        background-color: #27ae60;
    }

    .purple {
        background-color: #8e44ad;
    }

    .day-header {
        background-color: #34495e;
        color: white;
        font-size: 1em;
        padding: 12px;
        border-radius: 8px;
        font-weight: bold;
    }

    .details-box, .summary-box {
        margin-top: 40px;
        background-color: #f9f9f9;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        max-width: 900px;
        width: 100%;
        display: none;
        animation: slideDown 0.4s ease;
        position: relative;
    }

    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .section {
        margin-bottom: 20px;
    }

    .section h3 {
        margin-bottom: 8px;
        color: #2c3e50;
        font-size: 1.1em;
    }

    .section label {
        display: block;
        margin: 6px 0;
        cursor: pointer;
    }

    .complete-button {
        margin-top: 20px;
        padding: 10px 20px;
        background-color: #27ae60;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1em;
        cursor: pointer;
    }

    .complete-button:hover {
        background-color: #219653;
    }

    .close-button {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background-color: #95a5a6;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 6px 10px;
        font-size: 0.9em;
        cursor: pointer;
    }

    .countdown-container {
      position: absolute;
      top: 10px;
      right: 10px;
      display: none;
      align-items: center;
      gap: 6px;
      background: rgba(0,0,0,0.05);
      border-radius: 6px;
      padding: 4px 8px;
    }

    .countdown-btn {
      background: none;
      border: none;
      font-size: 1.2em;
      cursor: pointer;
      color: #2c3e50;
    }

    .countdown-btn:hover {
      color: #000;
    }

    .countdown-display {
      font-size: 0.95em;
      font-weight: bold;
      color: #2c3e50;
      min-width: 50px;
      text-align: center;
    }

    .log-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #8e44ad;
        color: white;
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        font-size: 1.5em;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(0,00,0,0.2);
        transition: transform 0.3s ease;
    }

    .log-button:hover {
        transform: scale(1.1);
    }

    .log-dropdown {
        position: fixed;
        bottom: 90px;
        right: 20px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        padding: 10px;
        max-height: 300px;
        overflow-y: auto;
        display: none;
        width: 250px;
    }

    .log-entry {
        padding: 8px;
        border-bottom: 1px solid #eee;
        font-size: 0.9em;
        cursor: pointer;
    }

    .log-entry:hover {
        background-color: #f0f0f0;
    }

    select, textarea {
        width: 100%;
        margin-top: 8px;
        padding: 6px;
        border-radius: 4px;
        border: 1px solid #ccc;
    }

    .summary-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .summary-header h2 {
        margin: 0;
        color: #2c3e50;
    }

    .summary-actions button {
        margin-left: 10px;
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9em;
    }

    .summary-actions .delete-btn {
        background-color: #e74c3c;
        color: white;
    }

    .summary-actions .note-btn {
        background-color: #f39c12;
        color: white;
    }

    .summary-actions .pdf-btn {
        background-color: #27ae60;
        color: white;
    }

    .summary-section {
        margin-bottom: 20px;
    }

    .summary-section h3 {
        margin-bottom: 8px;
        color: #34495e;
    }

    .summary-section ul {
        margin: 0;
        padding-left: 20px;
    }

    .summary-notes {
        margin-top: 20px;
        font-style: italic;
        color: #555;
    }

    /* --- Cuenta atr√°s --- */
    .countdown-container {
      position: absolute;
      top: 10px;
      right: 10px;
      display: none;
      align-items: center;
      gap: 6px;
      background: rgba(0,0,0,0.05);
      border-radius: 6px;
      padding: 4px 8px;
    }
    .countdown-btn {
      background: none;
      border: none;
      font-size: 1.2em;
      cursor: pointer;
      color: #2c3e50;
    }
    .countdown-btn:hover {
      color: #000;
    }
    .countdown-display {
      font-size: 0.95em;
      font-weight: bold;
      color: #2c3e50;
      min-width: 50px;
      text-align: center;
    }
  </style>
</head>
<body>

  <div class="calendar-wrapper">
    <!-- ‚úÖ Bot√≥n de YouTube con animaci√≥n y color -->
    <div class="youtube-button" onclick="window.open('https://www.youtube.com/playlist?list=LL', '_blank')" title="Abrir playlist de YouTube">
      ‚ñ∂Ô∏è
    </div>
    <h1>Calendario de Ejercicios de Escalada</h1>
    <p class="subtitle" id="weekRange"></p>

    <div class="top-buttons">
      <button class="top-button" onclick="completeWeek()">üìÑ Completar Semana</button>
    </div>

    <div class="calendar" id="weekCalendar"></div>
  </div>

  <!-- Caja de d√≠a -->
  <div class="details-box" id="detailsBox">
    <div class="countdown-container" id="countdownContainer">
      <button class="countdown-btn" onclick="startCountdown()" title="Iniciar">‚ñ∂Ô∏è</button>
      <span class="countdown-display" id="countdownDisplay">4:00</span>
      <button class="countdown-btn" onclick="resetCountdown()" title="Reiniciar">üîÑ</button>
    </div>

    <div class="section">
      <h3>üè† Entrenamiento en Casa</h3>
      <div id="homeTraining"></div>
    </div>
    <div class="section">
      <h3>üßó‚Äç‚ôÄÔ∏è Entrenamiento en la Roca</h3>
      <div id="rockTraining"></div>
    </div>
    <div class="section">
      <h3>üíä Suplementos</h3>
      <div id="supplements"></div>
    </div>
    <button class="complete-button" onclick="completeDay()">Completar d√≠a</button>
    <button class="close-button" onclick="closeDayBox()">‚ùå Cerrar</button>
  </div>

  <!-- Caja de resumen -->
  <div class="summary-box" id="summaryBox">
    <div class="summary-header">
      <h2>Resumen Semanal</h2>
      <div class="summary-actions">
        <button class="note-btn" onclick="addNote()">üìù A√±adir aclaraci√≥n</button>
        <button class="delete-btn" onclick="deleteSummary()">üóëÔ∏è Eliminar</button>
        <button class="pdf-btn" onclick="exportPDF()">üìÑ Exportar PDF</button>
      </div>
    </div>
    <div id="summaryContent"></div>
    <div class="summary-notes" id="summaryNotes"></div>
    <button class="close-button" onclick="closeSummaryBox()">‚ùå Cerrar</button>
  </div>

  <!-- Bot√≥n flotante Log -->
  <button class="log-button" onclick="toggleLog()">üìö</button>
  <div class="log-dropdown" id="logDropdown"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const dayNames = ["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado", "Domingo"];
    const dayColors = ["red", "green", "red", "green", "red", "purple", "purple"];
    const rockSectors = ["La Piscina", "El Kaos", "Tajao", "Las Eras", "Los Moriscos", "La Fuente", "Polegre", "Sector Pirata", "Sector Excreto", "Psicobloque", "Arafo", "Otro..."];
    let currentDayIndex = null;
    let currentSummaryKey = null;
    let currentNote = "";

    const redExercises = [
      "Resistencia: 4x4 Con lastre en la pared de presas",
      "Fuerza: Dominadas con lastre (4x3-5)",
      "Fuerza: Dominadas Explosivas (4x2)",
      "Fuerza: Dominadas al fallo (2 series)",
      "Flexibilidad: 15/20 Minutos de estiramientos"
    ];

    const greenExercises = [
      "Dedos: 4 Series de 10 segundos en 20mm",
      "Dedos: 4 Series de 10 segundos con lastre colgado",
      "Dedos: 4 Series colgado a 1 mano con lastre 7 segundos",
      "Flexibilidad: 15/20 Minutos de estiramientos"
    ];

    const purpleExercises = [
      "Descanso activo: Movilidad articular",
      "Recuperaci√≥n: Foam roller y respiraci√≥n"
    ];

    const saturdayFingerOptions = [
      "Dedos: 4 Series de 10 segundos en 20mm",
      "Dedos: 4 Series de 10 segundos con lastre colgado",
      "Dedos: 4 Series colgado a 1 mano con lastre 7 segundos"
    ];

    const saturdayStrengthOptions = [
      "Fuerza: Dominadas con lastre (4x3-5)",
      "Fuerza: Dominadas Explosivas (4x2)",
      "Fuerza: Dominadas al fallo (2 series)"
    ];

    // --- Cuenta atr√°s ---
    let countdownInterval = null;
    let countdownValue = 4 * 60; // 4 minutos en segundos
    let countdownDelayTimeout = null;

    function getWeekDates() {
      const today = new Date();
      const dayOfWeek = today.getDay();
      const monday = new Date(today);
      monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
      const week = [];
      for (let i = 0; i < 7; i++) {
        const date = new Date(monday);
        date.setDate(monday.getDate() + i);
        week.push(date);
      }
      return week;
    }

    function formatDateRange(dates) {
      const options = { day: 'numeric', month: 'long' };
      const start = dates[0].toLocaleDateString('es-ES', options);
      const end = dates[6].toLocaleDateString('es-ES', options);
      return `Semana del ${start} al ${end}`;
    }

    function isWeekCompleted() {
      const week = getWeekDates();
      const weekKey = `week-${week[0].toISOString().split('T')[0]}`;
      return localStorage.getItem(weekKey) !== null;
    }

    function renderCalendar() {
      const week = getWeekDates();
      const weekRange = formatDateRange(week);
      document.getElementById('weekRange').textContent = weekRange;

      const calendar = document.getElementById('weekCalendar');
      calendar.innerHTML = '';

      dayNames.forEach(name => {
        const header = document.createElement('div');
        header.className = 'day-header';
        header.textContent = name;
        calendar.appendChild(header);
      });

      const completed = isWeekCompleted();
      const today = new Date();
      const todayDate = today.toISOString().split('T')[0];

      week.forEach((date, index) => {
        const day = document.createElement('div');
        day.className = `day ${dayColors[index]}`;
        day.textContent = date.getDate();
        day.dataset.index = index;

        const dayKey = `day-${date.toISOString().split('T')[0]}`;
        const isCompleted = localStorage.getItem(dayKey) === 'completed';

        if (date.toISOString().split('T')[0] === todayDate && !completed && !isCompleted) {
          const icon = document.createElement('div');
          icon.className = 'today-icon';
          icon.textContent = '‚ö†Ô∏è';
          day.appendChild(icon);
        }

        if (completed) {
          day.classList.add('inactive');
        } else if (isCompleted) {
          day.classList.add('completed');
          const lockBtn = document.createElement('button');
          lockBtn.className = 'lock-button';
          lockBtn.textContent = 'üîì';
          lockBtn.onclick = (e) => {
            e.stopPropagation();
            reopenDay(index);
          };
          day.appendChild(lockBtn);
        } else {
          day.onclick = () => showDetails(index);
        }

        calendar.appendChild(day);
      });
    }

    function getSaturdayExercises() {
      const week = getWeekDates();
      const weekKey = `sat-extras-${week[0].toISOString().split('T')[0]}`;
      let finger = localStorage.getItem(`${weekKey}-finger`);
      let strength = localStorage.getItem(`${weekKey}-strength`);

      if (!finger) {
        finger = saturdayFingerOptions[Math.floor(Math.random() * saturdayFingerOptions.length)];
        strength = saturdayStrengthOptions[Math.floor(Math.random() * saturdayStrengthOptions.length)];
        localStorage.setItem(`${weekKey}-finger`, finger);
        localStorage.setItem(`${weekKey}-strength`, strength);
      }

      return [finger, strength];
    }

    function showDetails(index) {
      currentDayIndex = index;
      const color = dayColors[index];
      const isSaturday = index === 5;
      const isSunday = index === 6;
      const box = document.getElementById('detailsBox');
      box.style.display = 'block';

      // Mostrar cuenta atr√°s solo en d√≠as rojos
      const countdownContainer = document.getElementById('countdownContainer');
      if (color === 'red') {
        countdownContainer.style.display = 'flex';
        resetCountdown();
      } else {
        countdownContainer.style.display = 'none';
      }

      let homeHtml = '';

      if (color === 'red') {
        homeHtml = redExercises.map(item => `
          <label><input type="checkbox" class="training-checkbox"> ${item}</label>
        `).join('');
      } else if (color === 'green') {
        homeHtml = greenExercises.map(item => `
          <label><input type="checkbox" class="training-checkbox"> ${item}</label>
        `).join('');
      } else if (color === 'purple') {
        if (isSaturday) {
          const [finger, strength] = getSaturdayExercises();
          homeHtml += `
            <label><input type="checkbox" class="training-checkbox"> ${finger}</label>
            <label><input type="checkbox" class="training-checkbox"> ${strength}</label>
            <label><input type="checkbox" class="training-checkbox"> Cardio: 15 minutos de bici o carrera ligera</label>
          `;
        } else if (isSunday) {
          homeHtml = purpleExercises.map(item => `
            <label><input type="checkbox" class="training-checkbox"> ${item}</label>
          `).join('');
          homeHtml += `<label><input type="checkbox" class="training-checkbox"> Cardio: 15 minutos de bici o carrera ligera</label>`;
        }
      }

      // ‚úÖ Nueva opci√≥n: Abdominales (todos los d√≠as)
      homeHtml += `<label><input type="checkbox" class="training-checkbox"> Abdominales</label>`;

      document.getElementById('homeTraining').innerHTML = homeHtml;

      document.getElementById('rockTraining').innerHTML = `
        <select id="rockSelect" onchange="onRockSelect()">
          <option value="">-- Selecciona sector --</option>
          ${rockSectors.map(s => `<option value="${s}">${s}</option>`).join('')}
        </select>
        <textarea id="rockNotes" placeholder="Observaciones..." style="display:none; margin-top:8px;"></textarea>
      `;

      document.getElementById('supplements').innerHTML = `
        <label><input type="checkbox" class="supplement-checkbox"> Vitamina C</label>
        <label><input type="checkbox" class="supplement-checkbox"> Col√°geno</label>
      `;
    }

    function onRockSelect() {
      const select = document.getElementById('rockSelect');
      const notes = document.getElementById('rockNotes');
      notes.style.display = select.value ? 'block' : 'none';
    }

    function closeDayBox() {
      document.getElementById('detailsBox').style.display = 'none';
      resetCountdown();
    }

    function closeSummaryBox() {
      document.getElementById('summaryBox').style.display = 'none';
    }

    // --- Cuenta atr√°s ---
    function updateCountdownDisplay() {
      const mins = Math.floor(countdownValue / 60);
      const secs = countdownValue % 60;
      document.getElementById('countdownDisplay').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function startCountdown() {
      clearInterval(countdownInterval);
      clearTimeout(countdownDelayTimeout);
      countdownValue = 4 * 60;
      updateCountdownDisplay();

      countdownDelayTimeout = setTimeout(() => {
        countdownInterval = setInterval(() => {
          countdownValue--;
          updateCountdownDisplay();
          if (countdownValue <= 0) {
            clearInterval(countdownInterval);
            playBeep();
          }
        }, 1000);
      }, 5000); // 5 segundos de retardo
    }

    function resetCountdown() {
      clearInterval(countdownInterval);
      clearTimeout(countdownDelayTimeout);
      countdownValue = 4 * 60;
      updateCountdownDisplay();
    }

    function playBeep() {
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      oscillator.frequency.value = 800;
      oscillator.type = 'sine';
      gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
      oscillator.start(audioCtx.currentTime);
      oscillator.stop(audioCtx.currentTime + 0.5);
    }

    function completeDay() {
      if (currentDayIndex === null) return;

      const week = getWeekDates();
      const date = week[currentDayIndex];
      const dayKey = `day-${date.toISOString().split('T')[0]}`;

      const homeChecks = Array.from(document.querySelectorAll('#homeTraining input:checked')).map(i => i.parentElement.textContent.trim());
      const rockSector = document.getElementById('rockSelect')?.value || '';
      const rockNotes = document.getElementById('rockNotes')?.value || '';
      const suppChecks = Array.from(document.querySelectorAll('#supplements input:checked')).map(i => i.parentElement.textContent.trim());

      const data = {
        home: homeChecks,
        rock: { sector: rockSector, notes: rockNotes },
        supplements: suppChecks
      };

      localStorage.setItem(dayKey, 'completed');
      localStorage.setItem(`data-${dayKey}`, JSON.stringify(data));

      renderCalendar();
      closeDayBox();
    }

    function reopenDay(index) {
      const week = getWeekDates();
      const date = week[index];
      const dayKey = `day-${date.toISOString().split('T')[0]}`;
      localStorage.removeItem(dayKey);
      localStorage.removeItem(`data-${dayKey}`);
      renderCalendar();
    }

    function completeWeek() {
      const week = getWeekDates();
      const weekKey = `week-${week[0].toISOString().split('T')[0]}`;
      if (localStorage.getItem(weekKey)) {
        alert("Ya se ha generado un resumen de esta semana");
        return;
      }

      const summary = {};
      week.forEach((date, index) => {
        const dayKey = `day-${date.toISOString().split('T')[0]}`;
        const data = JSON.parse(localStorage.getItem(`data-${dayKey}`)) || {};
        summary[dayNames[index]] = {
          training: data.home || [],
          rock: data.rock || {},
          supplements: data.supplements || []
        };
      });

      localStorage.setItem(weekKey, JSON.stringify(summary));
      localStorage.setItem(`note-${weekKey}`, '');
      alert("Resumen de semana generado ‚úÖ");
      renderCalendar();
    }

    function toggleLog() {
      const dropdown = document.getElementById('logDropdown');
      dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
      renderLog();
    }

    function renderLog() {
      const dropdown = document.getElementById('logDropdown');
      dropdown.innerHTML = '';

      const keys = Object.keys(localStorage).filter(k => k.startsWith('week-')).sort().reverse();
      if (keys.length === 0) {
        dropdown.innerHTML = '<div class="log-entry">No hay res√∫menes guardados</div>';
        return;
      }

      keys.forEach(key => {
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        const date = key.replace('week-', '');
        entry.textContent = `Resumen semana del ${date}`;
        entry.onclick = () => {
          currentSummaryKey = key;
          currentNote = localStorage.getItem(`note-${key}`) || '';
          showSummary(JSON.parse(localStorage.getItem(key)));
        };
        dropdown.appendChild(entry);
      });
    }

    function showSummary(summary) {
      const box = document.getElementById('summaryBox');
      const content = document.getElementById('summaryContent');
      const notes = document.getElementById('summaryNotes');

      let html = '';
      for (const [day, data] of Object.entries(summary)) {
        html += `<div class="summary-section">`;
        html += `<h3>${day}</h3>`;
        html += `<strong>Entrenamiento en Casa:</strong><ul>`;
        html += data.training.map(t => `<li>${t}</li>`).join('');
        html += `</ul>`;
        html += `<strong>Entrenamiento en la Roca:</strong>`;
        if (data.rock.sector) {
          html += `<p>Sector: ${data.rock.sector}</p>`;
          if (data.rock.notes) html += `<p>Notas: ${data.rock.notes}</p>`;
        } else {
          html += `<p>No se realiz√≥ entrenamiento en roca.</p>`;
        }
        html += `<strong>Suplementos:</strong><ul>`;
        html += data.supplements.map(s => `<li>${s}</li>`).join('');
        html += `</ul></div>`;
      }

      content.innerHTML = html;
      notes.innerHTML = currentNote ? `<p><strong>Aclaraciones:</strong> ${currentNote}</p>` : '';
      box.style.display = 'block';
      box.scrollIntoView({ behavior: 'smooth' });
    }

    function addNote() {
      const note = prompt("A√±ade una aclaraci√≥n al resumen:", currentNote || '');
      if (note !== null) {
        currentNote = note;
        localStorage.setItem(`note-${currentSummaryKey}`, note);
        showSummary(JSON.parse(localStorage.getItem(currentSummaryKey)));
      }
    }

    function deleteSummary() {
      if (!currentSummaryKey) return;
      if (confirm("¬øEliminar este resumen? Podr√°s volver a generarlo.")) {
        localStorage.removeItem(currentSummaryKey);
        localStorage.removeItem(`note-${currentSummaryKey}`);
        closeSummaryBox();
        renderLog();
        renderCalendar();
      }
    }

    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const summary = JSON.parse(localStorage.getItem(currentSummaryKey));
      const note = localStorage.getItem(`note-${currentSummaryKey}`) || '';
      const week = getWeekDates();
      const start = week[0].toLocaleDateString('es-ES');
      const end = week[6].toLocaleDateString('es-ES');

      // Paleta de colores
      const colors = {
        red: [231, 76, 60],
        green: [39, 174, 96],
        purple: [142, 68, 173],
        headerBg: [52, 73, 94],
        text: [44, 62, 80],
        lightGray: [240, 240, 240],
      };

      // T√≠tulo
      doc.setFontSize(18);
      doc.setTextColor(...colors.text);
      doc.text('Resumen Semanal de Escalada', 14, 22);

      // Fechas
      doc.setFontSize(11);
      doc.text(`Semana: ${start} - ${end}`, 14, 30);

      let y = 40;
      const lineHeight = 6;
      const col1 = 14;
      const col2 = 80;
      const col3 = 140;

      // Encabezado de tabla
      doc.setFontSize(10);
      doc.setTextColor(255, 255, 255);
      doc.setFillColor(...colors.headerBg);
      doc.rect(col1, y, 182, 8, 'F');
      doc.text('D√≠a', col1 + 2, y + 6);
      doc.text('Entrenamiento en Casa', col2, y + 6);
      doc.text('Roca / Suplementos', col3, y + 6);
      y += 8;

      // Filas
      Object.entries(summary).forEach(([day, data], idx) => {
        const color = dayColors[dayNames.indexOf(day)];
        const fillColor = idx % 2 === 0 ? colors.lightGray : [255, 255, 255];
        doc.setFillColor(...fillColor);
        doc.rect(col1, y, 182, 20, 'F');

        // D√≠a
        doc.setFont(undefined, 'bold');
        doc.setTextColor(...colors[color]);
        doc.text(day, col1 + 2, y + 6);

        // Entrenamiento en Casa
        doc.setFont(undefined, 'normal');
        doc.setTextColor(...colors.text);
        const home = data.training.length ? data.training.join(', ') : '‚Äî';
        const homeLines = doc.splitTextToSize(home, 55);
        homeLines.forEach((line, i) => doc.text(line, col2, y + 6 + i * lineHeight));

        // Roca
        const rock = data.rock.sector ? `Sector: ${data.rock.sector}` : '‚Äî';
        doc.text(rock, col3, y + 6);

        // Suplementos
        const supp = data.supplements.length ? data.supplements.join(', ') : '‚Äî';
        const suppLines = doc.splitTextToSize(supp, 55);
        suppLines.forEach((line, i) => doc.text(line, col3, y + 12 + i * lineHeight));

        y += 20;
        if (y > 250) {
          doc.addPage();
          y = 20;
        }
      });

      // Notas
      if (note) {
        y += 10;
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text('Aclaraciones:', col1, y);
        y += 6;
        doc.setFont(undefined, 'normal');
        const noteLines = doc.splitTextToSize(note, 180);
        noteLines.forEach(line => {
          doc.text(line, col1, y);
          y += lineHeight;
        });
      }

      doc.save(`resumen_semanal_escalada_${start.replace(/\//g, '-')}_al_${end.replace(/\//g, '-')}.pdf`);
    }

    renderCalendar();
  </script>

</body>
</html>
